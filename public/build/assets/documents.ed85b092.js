import{r as h,c8 as P}from"./index.efc09bc1.js";function F(g={}){const{thumbnailScale:b=.5,enableDflip:v=!0,cdnBaseUrl:d="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174",storageBaseUrl:m=window.location.origin+"/storage",filters:D={type:"document"}}=g,l=h([]),u=h(!1),f=h(null),c=P(),L=async()=>{if(window.pdfjsLib)return window.pdfjsLib;try{return await Promise.all([new Promise(n=>{const t=document.createElement("script");t.src=`${d}/pdf.min.js`,t.onload=n,document.head.appendChild(t)}),new Promise(n=>{const t=document.createElement("script");t.src=`${d}/pdf.worker.min.js`,t.onload=n,document.head.appendChild(t)})]),await new Promise(n=>setTimeout(n,100)),window.pdfjsLib}catch(n){throw console.error("Failed to load PDF.js",n),n}},w=async(n,t=b)=>{try{const r=await L(),a=`${m}/${n}`,o=await(await r.getDocument(a).promise).getPage(1),i=document.createElement("canvas"),p=o.getViewport({scale:t}),y=i.getContext("2d");return i.width=p.width,i.height=p.height,await o.render({canvasContext:y,viewport:p}).promise,i.toDataURL("image/jpeg",.8)}catch(r){return console.error("Error generating thumbnail:",r),null}};return{documents:l,loading:u,error:f,processDocuments:async n=>{u.value=!0;try{const r=(await n()).map(async e=>{e.slug=e.slug||e.name.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,"");let s=0;try{if(!e.thumbnail_path&&e.publication_file.toLowerCase().endsWith(".pdf")){const o=await w(e.publication_file);e.thumb=o||void 0}else e.thumbnail_path&&(e.thumb=`${m}/${e.thumbnail_path}`);e.thumb&&(s=await new Promise(o=>{const i=new Image;i.onload=()=>o(i.height),i.onerror=()=>o(0),i.src=e.thumb}))}catch(o){console.error(`Error processing thumbnail for ${e.name}:`,o),s=0}return{...e,thumbnailHeight:s}}),a=await Promise.all(r);return l.value=a.sort((e,s)=>s.thumbnailHeight-e.thumbnailHeight),u.value=!1,l.value}catch(t){return u.value=!1,f.value=t instanceof Error?t:new Error(String(t)),console.error(t),[]}},initializeDflip:(n=l.value)=>{var t;if(!v||!n.length)return!1;if(n.forEach(r=>{r.publication_file.toLowerCase().endsWith(".pdf")&&(window[`df_option_${r.id}`]={source:`${m}/${r.publication_file}`,outline:[],autoEnableOutline:!1,autoEnableThumbnail:!1,overwritePDFOutline:!1,pageSize:"0",is3D:!0,direction:"1",slug:r.slug,wpOptions:"true",id:r.id})}),(t=window.DFLIP)!=null&&t.parseBooks){if(window.DFLIP.parseBooks(),c.currentRoute.value.hash){if(c.currentRoute.value.hash==="#_"){c.replace({hash:""});return}const r=n.find(a=>c.currentRoute.value.hash.includes(a.slug));r&&document.getElementById(`df_${r.id}`).click()}return!0}return console.warn("DFLIP library not loaded"),!1},generateThumbnail:w,handleRouteLeave:(n,t)=>{var e;const r=document.querySelector(".df-lightbox-wrapper"),a=r&&r.style.display!=="none";return console.log("Leaving route",t,n,a),window.DFLIP&&a?((e=document.querySelector(".df-lightbox-close"))==null||e.click(),!1):!0},filterDocuments:(n="")=>l.value.filter(t=>{const r=Object.entries(D).every(([e,s])=>t[e]===s),a=!n||Object.values(t).some(e=>String(e).toLowerCase().includes(n.toLowerCase()));return r&&a})}}export{F as u};
